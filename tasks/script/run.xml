<?xml version="1.0" encoding="UTF-8"?>
<project name="script" default="script">

  <dirname property="task.basedir" file="${ant.file.script}" />
  <basename property="task.name" file="${task.basedir}" />
  <property file="${task.basedir}/default.properties" />
  <property name="task.tool.dir" location="${task.basedir}/tool" />

  <property name="task.reports.dir" location="${dot.reports.dir}/${task.name}" />
  <property name="task.tmp.dir" location="${dot.ci.dir}/${task.name}" />

  <target name="init">
    <mkdir dir="${task.reports.dir}" />
    <mkdir dir="${task.tmp.dir}" />
  </target>

  <target name="script" depends="init">

    <tstamp>
      <format property="date.uuid" pattern="yyyyMMddhhmmss" locale="en,UK"/>
    </tstamp>

    <if>
      <equals arg1="code" arg2="" trim="true" />
      <then>
        <printLog message="code is empty" type="err" />
      </then>
    </if>

    <var name="script.filepath" unset="true" />

    <if>
      <istrue value="${os.unix}" />
      <then>
        <var name="script.filepath" value="${task.tmp.dir}/script-${date.uuid}.sh" />
        <echo file="${script.filepath}"><![CDATA[${code}]]>
        </echo>
        <chmod file="${script.filepath}" perm="755" />


        <if>
          <isset property="docker.run.image" />
          <then>

          <!-- save env output -->
          <exec executable="env" output="${task.tmp.dir}/env.list">
          </exec>

          <var name="##docker.run.options##" value="${docker.run.options} --env-file ${task.tmp.dir}/env.list" />
          <dockerRun
            image="${docker.run.image}"
            options="${##docker.run.options##}"
            command="bash ${script.filepath}"
            />

          </then>
          <else>
            <exec executable="bash" dir="${ws.dir}" failonerror="${failonerror}">
              <arg file="${script.filepath}" />
            </exec>
          </else>
        </if>

      </then>
      <elseif>
        <istrue value="${os.windows}" />
        <then>
          <var name="script.filepath" value="${task.tmp.dir}/code-${date.uuid}.bat" />
          <echo file="${script.filepath}"><![CDATA[${code}]]>
          </echo>
          <exec executable="cmd.exe" dir="${ws.dir}" failonerror="${failonerror}">
            <arg value="/c" />
            <arg file="${script.filepath}" />
          </exec>
        </then>
      </elseif>
      <else>
        <printLog
          messsage="current os is not support" 
          messsage.zh="当前系统不支持" 
          type="err" />
      </else>
    </if>

  </target>
</project>

